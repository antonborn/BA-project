---
title: "PrePhage3 pre-analysis"
author: "Antonborn & Clara-Isabel"
date: "2023-04-17"
output: html_document
---

```{r setup, include=FALSE}
p1 <- c("tidyverse", "vegan", "BiocManager")
p2 <- c("phyloseq", "ANCOMBC", "DESeq2", "ComplexHeatmap","MicrobiotaProcess","ggsci","directlabels","ggpubr")
load_package <- function(p) {
  if (!requireNamespace(p, quietly = TRUE)) {
    ifelse(p %in% p1, 
           install.packages(p, repos = "http://cran.us.r-project.org/"), 
           BiocManager::install(p))
  }
  library(p, character.only = TRUE, quietly = TRUE)
}
invisible(lapply(c(p1,p2), load_package))


```


```{r}
col_fil <- pal_jco("default")(10)

col_scale <- scale_color_jco()
```

#Build phyloseq object

```{r pressure, echo=FALSE}
otu <- read.table(file = "otu_prephage3_colon17042023.txt", sep = "\t", header = T, row.names = 1, 
                  skip = 0, comment.char = "")
taxonomy <- otu[,"taxonomy", drop = FALSE]
otu <- subset(otu, select = -taxonomy)

# clean the taxonomy, Greengenes format
tax <- taxonomy %>%
  select(taxonomy) %>% 
  separate(taxonomy, c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species"), ";")

tax.clean <- data.frame(row.names = row.names(tax),
                        Kingdom = str_replace(tax[,1], "k__",""),
                        Phylum = str_replace(tax[,2], "p__",""),
                        Class = str_replace(tax[,3], "c__",""),
                        Order = str_replace(tax[,4], "o__",""),
                        Family = str_replace(tax[,5], "f__",""),
                        Genus = str_replace(tax[,6], "g__",""),
                        Species = str_replace(tax[,7], "s__",""),
                        stringsAsFactors = FALSE)

tax.clean[is.na(tax.clean)] <- ""
tax.clean[tax.clean=="__"] <- ""

for (i in 1:nrow(tax.clean)){
  if (tax.clean[i,7] != ""){
    tax.clean$Species[i] <- paste(tax.clean$Genus[i], tax.clean$Species[i], sep = " ")
  } else if (tax.clean[i,2] == ""){
    kingdom <- paste("Unclassified", tax.clean[i,1], sep = " ")
    tax.clean[i, 2:7] <- kingdom
  } else if (tax.clean[i,3] == ""){
    phylum <- paste("Unclassified", tax.clean[i,2], sep = " ")
    tax.clean[i, 3:7] <- phylum
  } else if (tax.clean[i,4] == ""){
    class <- paste("Unclassified", tax.clean[i,3], sep = " ")
    tax.clean[i, 4:7] <- class
  } else if (tax.clean[i,5] == ""){
    order <- paste("Unclassified", tax.clean[i,4], sep = " ")
    tax.clean[i, 5:7] <- order
  } else if (tax.clean[i,6] == ""){
    family <- paste("Unclassified", tax.clean[i,5], sep = " ")
    tax.clean[i, 6:7] <- family
  } else if (tax.clean[i,7] == ""){
    tax.clean$Species[i] <- paste("Unclassified ",tax.clean$Genus[i], sep = " ")
  }
}

metadata <- read.table("Metadata2.txt", sep="\t", header=TRUE, row.names = 1, col.names=c("tax_id", "Extraction_ID", "Reference_ID", "Column1", "PigID", "Litter", "Group", "Sex", "Birthweight", "D2", "D3", "D4", "D5", "Growth", "ml_05_kg", "D1", "D22", "D33", "D44", "D55", "D16", "D27", "D38", "D49", "ml_16_kg_D1_16.00", "D1_11.00", "D1_kl_13.40_litter_1", "D1_kl_12_litter_2", "D2_kl_8.00", "D3_kl8", "D4_kl_7.30", "Total_leukocytes", "Total_erythrocytes", "Hemoglobin", "Hematocrit", "MCH", "MCHC", "Thrombocytes", "MPV", "MCV", "MPC", "Neut_percent", "Lymph_percent", "Mono_percent", "EOS_percent", "BASO_percent", "LUC_percent", "Neutrophiles", "Lymphocytes", "Monocytes", "Eosinophiles", "Basophiles", "LUC", "RET_percent", "Reticulocytes", "Intestinal_length", "Prox_SI", "Middle_SI", "Distal_SI", "Stomach_full", "Stomach_empty", "Colon_full", "Rel_colon", "Liver", "Rel_liver", "Spleen", "Heart", "Lungs", "Kidneys", "Stom_score", "Prox_score", "Mid_score", "Dist_score", "Colon_score", "ClinicalNEC_binary_4", "Lac_Mal_Ratio", "S_Hyperemia", "S_Hemorrhage", "S_Pneumatosis", "S_Necrosis", "SI_Hyperemia", "SI_Hemorrhage", "SI_Pneumatosis", "SI_Necrosis", "C_Hyperemia", "C_Hemorrhage", "C_Pneumatosis", "C_Necrosis", "D1_18", "D2_08", "D2_18", "D3_08", "D3_18", "D4_08", "D4_18", "D5_08", "D1_1811", "D2_0812", "D2_1813", "D3_0814", "D3_1815", "D4_0816", "D418", "D5_0817"))

metadata <- metadata[-1,] # remove first row


OTU = otu_table(as.matrix(otu), taxa_are_rows = TRUE)
TAX = phyloseq::tax_table(as.matrix(tax.clean))
SAMPLE <- sample_data(metadata)

# merge the data
ps <- phyloseq(OTU, TAX, SAMPLE)

saveRDS(ps, "ps.test.dbrda.rds")

```

```{r}
#library(ggplot2)
#library(dplyr)

#Litter1_df <- metadata %>% filter(Litter == "Litter1") %>% pull(Growth)
#Litter2_df <- metadata %>% filter(Litter == "Litter2")

#str(metadata)

#ggplot(Litter1_df, aes(x=Group, y=Growth)) +
#  geom_boxplot() +
#  labs(x = "Group", y = "Value") +
#  ggtitle("Boxplots by Group")

library(ggplot2)

# Create some sample data
set.seed(123)
metadata <- data.frame(
  Group = rep(c("Control1", "FFT1", "Control2", "FFT2"), each = 10),
  Growth = rnorm(40),
  Litter = rep(c("Litter1", "Litter2"), each = 20)
)

# Create the plot
ggplot(metadata, aes(x = Group, y = Growth, fill = Group)) +
  geom_boxplot(alpha = 0.1, lwd = 0.5) +
  facet_wrap(~ Litter, ncol = 2) +
  theme_classic() +
  theme(text = element_text(size = 8),
        axis.line = element_line(size = 1),
        axis.text = element_text(size = 8, colour = "Black"),
        axis.ticks = element_line(size = 1, colour = "Black"),
        strip.background = element_rect(colour = "white", fill = "white"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text.x = element_text(size = 8, angle = 0),
        legend.text = element_text(size = 8)) +
  labs(x = "Group", y = "Growth", fill = "Group")

```

```{r}
library(ggplot2)
ps.sample.rel <- subset_samples(ps_no_control, Group %in% c("Control","FFT"))
metadata <- sample_data(ps.sample.rel)
metadata$Growth <- as.numeric(metadata$Growth)

# Create some sample data
#set.seed(123)
#metadata <- data.frame(
#  Litter = rep(c("Litter1", "Litter2"), each = 20),
#  Group = rep(c("Control1", "FFT1", "Control2", "FFT2"), each = 10),
#  Growth = rnorm(40)
#)

# Create two separate plots for Litter1 and Litter2
p1 <- ggplot(metadata[metadata$Litter == "Litter1", ], aes(x = Group, y = Growth, fill = Group)) +
  geom_boxplot(alpha = 0.1, lwd = 0.5) +
  scale_fill_manual(values = c("#e34a33", "#31a354", "#e34a33", "#31a354"), 
                    breaks = c("Control1", "FFT1", "Control2", "FFT2"), 
                    labels = c("Control1", "FFT1", "Control2", "FFT2"), 
                    drop = FALSE) +
  theme_classic() +
  theme(text = element_text(size = 8),
        axis.line = element_line(size = 1),
        axis.text = element_text(size = 8, colour = "Black"),
        axis.ticks = element_line(size = 1, colour = "Black"),
        strip.background = element_rect(colour = "white", fill = "white"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text.x = element_text(size = 8, angle = 0),
        legend.text = element_text(size = 8)) +
  labs(x = "Group", y = "Growth", title = "Litter1")

p2 <- ggplot(metadata, aes(x = Litter, y = Growth, fill = Group)) +
  geom_boxplot(alpha = 0.1, lwd = 0.5) +
  scale_fill_manual(values = c("#e34a33", "#31a354", "#e34a33", "#31a354"), 
                    breaks = c("Control1", "FFT1", "Control2", "FFT2"), 
                    labels = c("Control1", "FFT1", "Control2", "FFT2"), 
                    drop = FALSE) +
  theme_classic() +
  theme(text = element_text(size = 8),
        axis.line = element_line(size = 1),
        axis.text = element_text(size = 8, colour = "Black"),
        axis.ticks = element_line(size = 1, colour = "Black"),
        strip.background = element_rect(colour = "white", fill = "white"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text.x = element_text(size = 8, angle = 0),
        legend.text = element_text(size = 8)) +
  labs(x = "Group", y = "Growth", title = "Litter2")

# Combine the two plots into one plot with two columns
gridExtra::grid.arrange(p1, p2, ncol = 2)





library(dplyr)

# Assuming metadata is a sample_data object
metadata_df <- data.frame(metadata)
Litter1_df <- metadata_df %>% filter(Litter == "Litter1")
Litter2_df <- metadata_df %>% filter(Litter == "Litter2")

# Extract values from data frames
litter1 <- Litter1_df$Group
litter2 <- Litter2_df$Group


# Create paired dataset by matching on SampleID
#paired_df <- inner_join(Litter1_df, Litter2_df, by = "Growth")

# Perform paired t-test on paired dataset
#t.test(paired_df$Growth.x, paired_df$Growth.y, paired = TRUE)


#nrow(Litter1_df)
#nrow(Litter2_df)

```



```{r}

library(ggplot2)
library(dplyr)

meta_cleaned <- read.table("Meta_cleaned.txt", sep="\t", header=TRUE)

# Add new column 'NEC_incidence' with blank values
meta_cleaned <- meta_cleaned %>%
  mutate(NEC_incidence = "") %>%
  select(-5) %>%
  mutate(Group = case_when(
    Group %in% c("FFT1", "FFT2") ~ "FFT",
    Group %in% c("Control1", "Control2") ~ "Control",
    TRUE ~ as.character(Group)
  ))

# Update the 'NEC_incidence' column based on 'Colon_score'
meta_cleaned$NEC_incidence <- ifelse(meta_cleaned$Colon_score >= 4, "NEC", "No NEC")

# Create a boxplot with scatter points
ggplot(filtered_meta, aes(x = Group, y = Growth, fill = Group)) +
  geom_boxplot(alpha = 0) +
  geom_jitter(data = filtered_meta %>% filter(NEC_incidence == "NEC"), 
              width = 0.2, height = 0, color = "grey", shape = 17, size = 2) +
  geom_jitter(data = filtered_meta %>% filter(NEC_incidence != "NEC"), 
              width = 0.2, height = 0, color = "black", shape = 16, size = 2) +
  scale_shape_manual(values = c(16, 17)) +
  labs(x = "Treatment", y = "Growth (g/day)", fill = "Treatment") +
  ggtitle("Boxplot of Growth per day by Treatment Type") +
  theme_minimal()



# Subset the metadata dataset for 'FFT' and 'Control' groups
fft_data <- metadata[metadata$Group == "FFT", "Growth"]
control_data <- metadata[metadata$Group == "Control", "Growth"]

# Perform Welch's t-test
result <- t.test(fft_data$Growth, control_data$Growth, var.equal = FALSE)

# Print the t-test results
print(result)



```


## Statistic
We could see tongue samples had the lowest alpha diversity. Next, some statistics: pairwise test with Wilcoxon rank-sum test, corrected by FDR method. For the number of observed tags
```{r}
rich = estimate_richness(ps_no_control, measures = c("Observed", "Shannon"))
wilcox.observed <- pairwise.wilcox.test(rich$Observed, 
                                        sample_data(ps_no_control)$Group, 
                                        p.adjust.method = "BH")
tab.observed <- wilcox.observed$p.value %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "group1") %>%
  gather(key="group2", value="p.adj", -group1) %>%
  na.omit()
tab.observed
```

```{r}
wilcox.shannon <- pairwise.wilcox.test(rich$Shannon, 
                                       sample_data(ps_no_control)$Group, 
                                       p.adjust.method = "BH")
tab.shannon <- wilcox.shannon$p.value %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "group1") %>%
  gather(key="group2", value="p.adj", -group1) %>%
  na.omit()
tab.shannon
```

#Beta diversity
## With reference ID
```{r, eval = T, include = T, echo = F, massage = F}
##Do PCoA ordination based on Bray-curtis distance
GP.ord_bray <- ordinate(ps_no_control, "PCoA", "bray")

beta.id_bray <- phyloseq::plot_ordination(ps_no_control, GP.ord_bray, color="Group") + 
  geom_point(aes(shape = Litter), size = 3) +
  theme_classic() + 
  theme(plot.title = element_text(size = 12, face = "bold",hjust = 0.5),
        strip.background = element_blank(),
        strip.text.x = element_blank()) + 
  scale_x_reverse() +
  ggtitle("Beta Diversity using Bray-Curtis")

beta.id_bray

#
anova_bray <- data.frame(phyloseq::sample_data(ps_no_control))

dist = phyloseq::distance(ps_no_control, method="bray")
anova_bray$Group <- factor(anova_bray$Group, levels = c("Control", "FFT"))

test.adonis <- vegan::adonis2(t(ps_no_control@otu_table) ~ Group, data = anova_bray, method = "bray")
test.adonis

```

## Beta diversity jaccard
```{r}
#Do PCoA ordination based on Bray-curtis distance
GP.ord_jaccard <- ordinate(ps_no_control, "PCoA", "jaccard")

beta.id_jaccard <- phyloseq::plot_ordination(ps_no_control, GP.ord_jaccard, color="Group") + 
  geom_point(aes(shape = Litter), size = 3) +
  theme_classic() + 
  theme(plot.title = element_text(size = 12, face = "bold",hjust = 0.5),
        strip.background = element_blank(),
        strip.text.x = element_blank()) + 
  scale_x_reverse() +
  ggtitle("Beta Diversity using Jaccard")

beta.id_jaccard 

#
dist = phyloseq::distance(ps_no_control, method="jaccard")
anova_jac$Group <- factor(anova_jac$Group, levels = c("Control", "FFT"))

anova_jac <- data.frame(phyloseq::sample_data(ps_no_control))

test.adonis <- vegan::adonis2(t(ps_no_control@otu_table) ~ Group, data = anova_jac, method = "jaccard")
test.adonis


vegan::betadisper(test.adonis )

test.adonis <- as.data.frame(test.adonis$aov.tab)
test.adonis

scores(test.adonis, display = "site")

```

```{r}

# Create the phyloseq object
meta_cleaned <- phyloseq(otu_table, sample_data)
sample_data$NEC_incidence[sample_data$NEC_incidence == "No NEC"] <- "No_NEC"
sample_data <- sample_data %>% filter(NEC_incidence != "NA") 


# Continue with the rest of your analysis
dist <- phyloseq::distance(meta_cleaned, method = "jaccard")
bray_dist = phyloseq::distance(OTU, method = "bray")

anova_jac <- data.frame(phyloseq::sample_data(meta_cleaned))
sample_data$NEC_incidence <- factor(sample_data$NEC_incidence, levels = c("NEC", "No_NEC"))
samp_df = sample_data[sample_data$tax_id %in% dimnames(dist), ]

test.adonis <- vegan::adonis2(dist ~ NEC_incidence + , data = samp_df)
?adonis2
# Bray adonis

bray_dist = as.matrix(bray_dist)

bray_dist = bray_dist[rownames(bray_dist) %in% samp_df$tax_id, colnames(bray_dist) %in% samp_df$tax_id] 
samp_df$

adonis_bray <- vegan::adonis2(bray_dist ~ NEC_incidence + Group, data = samp_df)



```



## Group：axis1：2
```{r, eval = T, include = T, echo = F, message = F}
beta.treatment = phyloseq::plot_ordination(ps_no_control, GP.ord, axes = 1:2,color="Group") +
  stat_ellipse(aes(colour = Group), geom = "polygon", level = 0.95, fill = NA, size = 1) +
  scale_color_manual(values=c("#F27970","#32B897"), breaks = c("Control", "FFT"), labels = c("Control", "FFT")) +
  geom_point(aes(shape = ifelse(Litter == "Litter1", "Litter1", "Litter2"), size = 0.5)) +
  guides(shape = guide_legend(title = "Litter"), size = FALSE) +
  theme_classic() + 
  theme(plot.title = element_text(size = 12, face = "bold",hjust = 0.5),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10)) + 
  scale_x_reverse() +
  ggtitle("Beta diversity between litter and treatment groups")

beta.treatment
```
## Treatment group with only Control1 and FFT1
```{r, eval = T, include = T, echo = F, message = F}
#Keep only true samples
ps_no_control <- subset_samples(ps.rarefied, Group %in% c("Control","FFT"))
GP.ord <- ordinate(ps_no_control, "PCoA", "bray")

beta.treatment = phyloseq::plot_ordination(ps_no_control, GP.ord, axes = 1:2,color="Group") +   #Change axes to 2:3 3:4 4:5 and see how does other demensions looks like
  #Change 'color' to litter or another column name to 
  stat_ellipse(geom = "polygon", level = 0.95, fill = NA, size = 1) +              
  scale_color_jco() +
  theme_classic() + 
  theme(plot.title = element_text(size = 12, face = "bold",hjust = 0.5),          #set the font and size of the text
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10)
  ) + 
  # geom_point(size = 3) +
  scale_x_reverse() +# Revert x-axis to match plots
  ggtitle("Bacteriome")+
  scale_color_manual(
                    values=c("#F27970","#BB9727"),           #set certain color for the groups
                    breaks = c( "Control1", "FFT1"),
                    labels = c( "Control1", "FFT1")
                    )

beta.treatment
```
# Abundant barplots
## Individual sample barplots.

```{r, eval = T, include = T, echo = F, message = F}



bac.phyl <- tax_glom(ps, "Genus", NArm = FALSE)

ps0 <- transform_sample_counts(bac.phyl, function(x) x / sum(x))

#Create melted dataframe
df <- psmelt(ps0)

#Select last non-empty taxonomic rank
df[df==""] <- NA

df$tax <- apply(df, 1, function(x) tail(na.omit(x), 1))

#Arrange samples by mean abundance
top <- df %>%
  group_by(Reference_ID, Litter,tax) %>%
  dplyr::summarize(Mean = mean(Abundance)) %>%
  arrange(-Mean)
#Show top
#top

top10 <- top$tax[1:150]
df0 <- df %>%
  mutate(tax = fct_other(tax, c(as.matrix(top10))))

df0 <- df0[order(df0$Sample, decreasing = TRUE), ]

barplot.all.samples <- ggplot(df0, aes(Reference_ID, Abundance, fill = fct_reorder(tax, Abundance, .fun = mean))) + 
  geom_col(width = 0.8) +
  #facet_wrap("Group")+
  scale_fill_jco(name = "Taxonomy") +
  scale_fill_manual(values=rep(col_fil,5),name="Genus")+
  theme_classic() +
  theme(text = element_text(size = 10, colour = "Black"),
        axis.line=element_line(size=0.5),
        #panel.border = element_blank(),
        axis.text=element_text(size = 10, colour = "Black"),
        axis.ticks=element_line(size=1, colour = "Black"),
        strip.background = element_rect(colour = "white", fill = "white"),
        axis.text.x=element_text(angle = 45, hjust = 1),
        strip.text.x = element_text(angle = 0, size=12, face = "bold"),
        #legend.position = "none"
  ) +
  ylab("Relative abundance")


barplot.all.samples

```


## NEC
```{r}
library(dplyr)

NEC_df <- read.table("NEC.txt", sep="\t", header=TRUE)

NEC_table <- NEC_df %>% 
  mutate(Treatment = ifelse(grepl("FFT", Treatment), "FFT", "Control"),
         Nec_incidence = ifelse(NEC_score >= 4, "NEC", "No Nec")) %>%
  group_by(Treatment, Nec_incidence) %>%
  summarize(count = n()) %>%
  pivot_wider(names_from = Nec_incidence, values_from = count) %>%
  mutate(Total = NEC + `No Nec`) %>%
  mutate(Nec_percentage = round((NEC / Total) * 100, 2)) %>%
  select(Treatment, NEC, `No Nec`, Total, Nec_percentage)

colnames(NEC_table) <- c("Treatment", "NEC Incidence", "No NEC Incidence", "Total Amount of Pigs", "NEC Percentage")

# Format the table for printing
NEC_table %>%
  knitr::kable(format = "html", align = "c", caption = "NEC Incidence Compared Between Treatment Groups") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)



# Subset the data for the two treatment groups
FFT_scores <- NEC_df$NEC_score[grepl("FFT", NEC_df$Treatment)]
Control_scores <- NEC_df$NEC_score[!grepl("FFT", NEC_df$Treatment)]

# Perform a t-test
t.test(FFT_scores, Control_scores)



```

```{r}
library(dplyr)
library(ggplot2)

# Filter data for FFT group
fft_leuk <- meta_leuk %>%
  filter(!is.na(Total_leukocytes)) %>%
  filter(Group == "FFT") %>%
  select(Group, Total_leukocytes)

# Filter data for Control group
control_leuk <- meta_leuk %>%
  filter(!is.na(Total_leukocytes)) %>%
  filter(Group == "Control") %>%
  select(Group, Total_leukocytes)

# Remove missing values from Total_leukocytes and convert to numeric
meta_leuk$Total_leukocytes <- as.numeric(meta_leuk$Total_leukocytes)
meta_leuk <- meta_leuk[complete.cases(meta_leuk$Total_leukocytes),]

# Create boxplot
ggplot(meta_leuk, aes(x = Group, y = Total_leukocytes, fill = Group)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, height = 0, color = "black", size = 2) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "white", color = "black") +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  labs(x = "Treatment", y = "Total Leukocytes", fill = "Treatment") +
  ggtitle("Boxplot of Total Leukocytes by Treatment Group") +
  theme_minimal()

ttest <- t.test(fft_leuk$Total_leukocytes, control_leuk$Total_leukocytes)
print(ttest)


```


```{r}

library(ggplot2)
library(dplyr)

meta_cleaned <- read.table("Meta_cleaned.txt", sep="\t", header=TRUE)

# Add new column 'NEC_incidence' with blank values
meta_cleaned <- cbind(meta_cleaned[, 1:4], NEC_incidence = "", meta_cleaned[, 5:ncol(meta_cleaned)])

# Update the 'NEC_incidence' column based on 'Colon_score'
meta_cleaned$NEC_incidence <- ifelse(meta_cleaned$Colon_score >= 4, "NEC", "No NEC")

# Modify the 'Group' column
meta_cleaned$Group <- gsub("FFT[12]", "FFT", meta_cleaned$Group)
meta_cleaned$Group <- gsub("Control[12]", "Control", meta_cleaned$Group)

# Filter out rows with NA values in the specified columns
filtered_meta <- meta_cleaned %>%
  filter(!is.na(Neutrophiles) & !is.na(Lymphocytes) & !is.na(Monocytes))

# Calculate count of observations per group
count_data <- filtered_meta %>%
  group_by(Group) %>%
  summarize(count = n())

# Create scatter plots with different shapes for NEC and non-NEC points
plot_neutrophiles <- ggplot(filtered_meta, aes(x = Group, y = Neutrophiles, color = Group)) +
  geom_boxplot(fill = "white") +
  geom_jitter(data = filtered_meta %>% filter(NEC_incidence == "NEC"), 
              width = 0.2, height = 0, color = "grey", shape = 17, size = 2) +
  geom_jitter(data = filtered_meta %>% filter(NEC_incidence != "NEC"), 
              width = 0.2, height = 0, color = "black", shape = 16, size = 2) +
  annotate(
    "text",
    x = count_data$Group, y = max(filtered_meta$Neutrophiles),
    label = paste("n =", count_data$count),
    vjust = -1
  ) +
  labs(x = "Group", y = "Neutrophiles", color = "Group", shape = "NEC Incidence") +
  ggtitle("Boxplot with Scatter Plot of Neutrophiles by Group") +
  theme_minimal()

# Add labels to the scatter points
plot_neutrophiles <- plot_neutrophiles +
  scale_shape_manual(values = c(16, 17), labels = c("No NEC", "NEC")) +
  labs(shape = "NEC Incidence",
       legend = list(title = "Legend", 
                     labels = c("No NEC: Triangles", "NEC: Circles")))

plot_lymphocytes <- ggplot(filtered_meta, aes(x = Group, y = Lymphocytes, color = Group)) +
  geom_boxplot(fill = "white") +
  geom_jitter(data = filtered_meta %>% filter(NEC_incidence == "NEC"), 
              width = 0.2, height = 0, color = "grey", shape = 17, size = 2) +
  geom_jitter(data = filtered_meta %>% filter(NEC_incidence != "NEC"), 
              width = 0.2, height = 0, color = "black", shape = 16, size = 2) +
  annotate(
    "text",
    x = count_data$Group, y = max(filtered_meta$Lymphocytes),
    label = paste("n =", count_data$count),
    vjust = -1
  ) +
  labs(x = "Group", y = "Lymphocytes", color = "Group", shape = "NEC Incidence") +
  ggtitle("Boxplot with Scatter Plot of Lymphocytes by Group") +
  theme_minimal()

# Add labels to the scatter points
plot_lymphocytes <- plot_lymphocytes +
  scale_shape_manual(values = c(16, 17), labels = c("No NEC", "NEC")) +
  labs(shape = "NEC Incidence",
       legend = list(title = "Legend", 
                     labels = c("No NEC: Triangles", "NEC: Circles")))

plot_monocytes <- ggplot(filtered_meta, aes(x = Group, y = Monocytes, color = Group)) +
  geom_boxplot(fill = "white") +
  geom_jitter(data = filtered_meta %>% filter(NEC_incidence == "NEC"), 
              width = 0.2, height = 0, color = "grey", shape = 17, size = 2) +
  geom_jitter(data = filtered_meta %>% filter(NEC_incidence != "NEC"), 
              width = 0.2, height = 0, color = "black", shape = 16, size = 2) +
  annotate(
    "text",
    x = count_data$Group, y = max(filtered_meta$Monocytes),
    label = paste("n =", count_data$count),
    vjust = -1
  ) +
  labs(x = "Group", y = "Monocytes", color = "Group", shape = "NEC Incidence") +
  ggtitle("Boxplot with Scatter Plot of Monocytes by Group") +
  theme_minimal()

# Add labels to the scatter points
plot_monocytes <- plot_monocytes +
  scale_shape_manual(values = c(16, 17), labels = c("No NEC", "NEC")) +
  labs(shape = "NEC Incidence",
       legend = list(title = "Legend", 
                     labels = c("No NEC: Triangles", "NEC: Circles")))

# Display the updated plots
plot_neutrophiles
plot_lymphocytes
plot_monocytes


```


```{r}
# Filter out rows with NA values in the specified columns
filtered_meta <- meta_cleaned %>%
  filter(!is.na(Lac.Mal.Ratio))

lacmal_removed <- filtered_meta[-1, ]

# Convert Lac.Mal.Ratio column to numeric
lacmal_removed$Lac.Mal.Ratio <- as.numeric(lacmal_removed$Lac.Mal.Ratio)

# Calculate average and median scores per group
summary_data <- lacmal_removed %>%
  group_by(Group) %>%
  summarize(avg_score = mean(Lac.Mal.Ratio), med_score = median(Lac.Mal.Ratio))

# Create bar plot of average scores
bar_plot <- ggplot(summary_data, aes(x = Group, y = avg_score, fill = Group)) +
  geom_bar(stat = "identity") +
  labs(x = "Group", y = "Average Score", fill = "Group") +
  ggtitle("Bar Plot of Average Scores") +
  theme_minimal()

# Add scatter points with different shapes for NEC and non-NEC points
scatter_plot <- bar_plot +
  geom_jitter(data = lacmal_removed %>% filter(NEC_incidence == "NEC"), 
              aes(x = Group, y = Lac.Mal.Ratio, shape = NEC_incidence), 
              width = 0.2, height = 0, color = "grey", size = 2) +
  geom_jitter(data = lacmal_removed %>% filter(NEC_incidence != "NEC"), 
              aes(x = Group, y = Lac.Mal.Ratio, shape = NEC_incidence), 
              width = 0.2, height = 0, color = "black", size = 2) +
  scale_shape_manual(values = c(16, 17), labels = c("No NEC", "NEC")) +
  labs(shape = "NEC Incidence",
       legend = list(title = "Legend", 
                     labels = c("No NEC: Triangles", "NEC: Circles")))

# Print the summary data
print(summary_data)

# Print the combined plot
print(scatter_plot)
```




```{r}
library(dplyr)
library(ggplot2)

NEC_leuk_df <- read.table("NEC_and_Leuk.txt", sep="\t", header=TRUE)
NEC_leuk_df <- na.omit(NEC_leuk_df)

NEC_grouped <- NEC_leuk_df %>%
  group_by(NEC_score) %>%
  summarise(average_leuk = mean(Total.leukocytes))

ggplot(NEC_leuk_df, aes(x = factor(NEC_score), y = Total.leukocytes, fill = factor(NEC_score))) +
  geom_boxplot() +
  geom_jitter(width = 0.2, height = 0, color = "black", alpha = 1) +
  scale_fill_manual(values = c("steelblue", "steelblue", "firebrick3", "firebrick3")) +
  labs(x = "NEC Score", y = "Total Leukocytes", fill = "NEC Score") +
  ggtitle("Total Leukocytes by NEC Score")


```

```{r}
library(ggplot2)
library(ggbeeswarm)
library(lmerTest)
install.packages("lsmeans")
library(lsmeans)

meta_clean <- read.table("Meta_clean.txt", sep="\t", header=TRUE)

data_tab <- meta_clean(Treatment$NEC_score)
data_tab <- subset(data_tab, select = c(ID, Group, NEC_max, Litter))
data_tab_f <- NEC_score_df[data_tab$ID %in% mapping$FMT_ID,]
data_tab_f$Group <- factor(data_tab_f$Treatment, levels = c("CON", "NEW", "OLD"), labels = c("CON", "FMT1", "FMT2"))
data_tab_long <- reshape2::melt(data_tab_f, id.vars = c("ID", "Group", "Litter"))

lm_fun <- function(data_tab_long) {
  lmer.fit <- lmer(value ~ Group + (1|Litter), data = data_tab_long) 
  sum_tukey <- lsmeans(lmer.fit, pairwise ~ Group, adjust = "tukey")
  tab <- as.data.frame(sum_tukey$contrasts)
  
  groups <- setDT(tstrsplit(as.character(tab$contrast), " - ", fixed = TRUE))[]
  
  stat.test <- tibble(group1 = groups$V1, group2 = groups$V2, p.adj = tab$p.value)
  stat.test$p.adj.signif <- case_when(stat.test$p.adj >= 0.05 ~ NA,
                                      stat.test$p.adj < 0.05 ~ "*",
                                      stat.test$p.adj < 0.01 ~ "**",
                                      stat.test$p.adj < 0.001 ~ "***")
  return(stat.test)
}

stat.test <- lm_fun(data_tab_long)

stat.test <- stat.test %>%
  filter(p.adj < 0.05) %>%
 

NEC_score_df$NEC_score <- factor(NEC_score_df$NEC_score, levels = c(1:6))

p_NECseverity <- ggplot(NEC_score_df, aes(x = Treatment, y = NEC_score)) +
  geom_violin(aes(fill = Treatment)) +
  geom_beeswarm(cex = 2, size = 2, aes(color = NEC_score)) +
  geom_hline(yintercept = 3.5, linetype = "dashed", color = "black") +
  scale_color_manual(values = c("black", "gray", "black", "gray", "black", "gray")) +
  scale_fill_manual(values = c("#0072B2", "#D55E00", "#F0E442", "#009E73")) +
  labs(x = "", y = "NEC max scores", title = "") +
  scale_y_discrete(breaks = seq(1, 6, 1)) +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, family = "Arial", size = 12, face = "bold"),
        legend.text = element_text(family = "Arial", size = 10),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text = element_text(family = "Arial", size = 10, vjust = 1),
        axis.text = element_text(family = 'Arial', size = 10, color = "black"),
        axis.ticks.x = element_blank(),
        panel.grid = element_blank())

p_NECseverity



```



# Abundance heatmaps

# Heatmap base on deseq 

```{r}
# load data to calculate the matrix
ps_no_control <- subset_samples(ps.rarefied, Group %in% c("Control","FFT"))

metadata <- data.frame(sample_data(ps_no_control),check.names = FALSE)

abun_matri <- data.frame(otu_table(ps_no_control),check.names = FALSE)
abun_matri_t <- t(abun_matri)
library(reshape2)
rel_tab_l <- melt(abun_matri_t,variable.name = "mags")
colnames(rel_tab_l) <- c("sample","mags","abundance")

# match the Group information
index <- match(rel_tab_l$sample, rownames(metadata))
table(is.na(index))
rel_tab_l$Group <- metadata$Group[index]




library(rstatix)
#1
tab_CON1_CON2_all <- rel_tab_l %>%
  filter(Group %in% c("Control") ) %>%
  group_by(mags) %>%
#  kruskal_test(abundance~Group) #%>%
  # adjust_pvalue(method = "BH")%>%
  # add_significance("p.adj") 
#2
tab_CON1_FFT1_all <- rel_tab_l %>%
  filter(Group %in% c("Control", "FFT") ) %>%
  group_by(mags) %>%
  kruskal_test(abundance~Group) #%>%
  # adjust_pvalue(method = "BH")%>%
  # add_significance("p.adj") 
#3
tab_CON1_FFT2_all <- rel_tab_l %>%
  filter(Group %in% c("Control", "FFT") ) %>%
  group_by(mags) %>%
  kruskal_test(abundance~Group) #%>%
  # adjust_pvalue(method = "BH")%>%
  # add_significance("p.adj") 
#4
tab_CON2_FFT1_all <- rel_tab_l %>%
  filter(Group %in% c("Control", "FFT") ) %>%
  group_by(mags) %>%
  kruskal_test(abundance~Group) #%>%
  # adjust_pvalue(method = "BH")%>%
  # add_significance("p.adj") 
#5
tab_CON2_FFT2_all <- rel_tab_l %>%
  filter(Group %in% c("Control", "FFT") ) %>%
  group_by(mags) %>%
  kruskal_test(abundance~Group) #%>%
  # adjust_pvalue(method = "BH")%>%
  # add_significance("p.adj") 
#6
#tab_FFT1_FFT2_all <- rel_tab_l %>%
#  filter(Group %in% c("FFT") ) %>%
#  group_by(mags) %>%
#  kruskal_test(abundance~Group) #%>%
  # adjust_pvalue(method = "BH")%>%
  # add_significance("p.adj") 



#Include wilcoxon p.adj FMT2 vs CON, FMT2 vs FMT1, taxonomy for rows
tab_CON1_CON2 <- subset(tab_CON1_CON2_all, p < 0.05)
tab_CON1_FFT1 <-subset(tab_CON1_FFT1_all, p < 0.05)
tab_CON1_FFT2 <- subset(tab_CON1_FFT2_all, p < 0.05)
tab_CON2_FFT1 <- subset(tab_CON2_FFT1_all, p < 0.05)
tab_CON2_FFT2 <-subset(tab_CON2_FFT2_all, p < 0.05)
tab_FFT1_FFT2 <- subset(tab_FFT1_FFT2_all, p < 0.05)
ASV <- unique(c(as.character(tab_CON1_CON2$mags), #1
                as.character(tab_CON1_FFT1$mags), #2
                as.character(tab_CON1_FFT2$mags), #3
                as.character(tab_CON2_FFT1$mags), #4
                as.character(tab_CON2_FFT2$mags), #5
                as.character(tab_FFT1_FFT2$mags))) #6
             

ps.sample.rel <- subset_samples(ps_no_control, Group %in% c("Control","FFT"))

# 
# #only take the donors belong mags
# tax <- data.table::as.data.table(tax_table(ps.sample.rel),keep.rownames = TRUE)
# index <- as.character(tax$Genus) 
# tax_lac <- tax[index,]$rn 
# ps.sample.rel.donor <- prune_taxa(tax_lac,ps.sample.rel)
# ps.sample.rel.donor
# ps.sample.rel.test <- readRDS("ps_denovo_mags_donorSource.rds")
# tax.ttest<- data.table::as.data.table(tax_table(ps.sample.rel.test),keep.rownames = TRUE)
# A<-ps.sample.rel@tax_table
#different by p different colonized in FMT1 and FMT2

Vector1 <- as.character(tab_CON1_CON2$mags)
Vector2 <- as.character(tab_CON1_FFT1$mags)
Vector3 <- as.character(tab_CON1_FFT2$mags)
Vector4 <- as.character(tab_CON2_FFT1$mags)
Vector5 <- as.character(tab_CON2_FFT2$mags)
Vector6 <- as.character(tab_FFT1_FFT2$mags)

merge_vector <- unique(c(Vector1,Vector2,Vector3,Vector4,Vector5,Vector6))

ps.sample.rel.sig <- prune_taxa(merge_vector,ps.sample.rel)
ps.sample.rel.sig

otu_abun_select <- data.frame(otu_table(ps.sample.rel.sig), check.names = F)
#import relavant metadata
metadata <- sample_data(ps.sample.rel.sig)
tax.clean <- data.frame(phyloseq::tax_table(ps.sample.rel.sig))
# use complex heatmap for visualization, multiple row annotation
# extract the relative abundance matrix for thoes responding signals

library(ComplexHeatmap)
library(dplyr)
library(circlize)

# order the matrix by the subgroup
metadata$Group <- factor(metadata$Group, levels = c("Control1","Control2","FFT1","FFT2"))
meta_order <- metadata[order(metadata$Group),]
# re_order the col
mat <- otu_abun_select
mat <- as.matrix(mat[,rownames(meta_order)])



base_mean = rowMeans(mat)
mat_scaled = t(scale(t(mat)))
# calculate heatmap annotation
tax_heatmap <- tax.clean[rownames(mat_scaled),]
tax_heatmap$tab_CON1_CON2 <- sapply(rownames(tax_heatmap), function(x) ifelse(x %in% tab_CON1_CON2$mags,"*","ns"))
tax_heatmap$tab_CON1_FFT1 <- sapply(rownames(tax_heatmap), function(x) ifelse(x %in% tab_CON1_FFT1$mags,"*","ns"))
tax_heatmap$tab_CON1_FFT2 <- sapply(rownames(tax_heatmap), function(x) ifelse(x %in% tab_CON1_FFT2$mags,"*","ns"))
tax_heatmap$tab_CON2_FFT1 <- sapply(rownames(tax_heatmap), function(x) ifelse(x %in% tab_CON2_FFT1$mags,"*","ns"))
tax_heatmap$tab_CON2_FFT2 <- sapply(rownames(tax_heatmap), function(x) ifelse(x %in% tab_CON2_FFT2$mags,"*","ns"))
tax_heatmap$tab_FFT1_FFT2 <- sapply(rownames(tax_heatmap), function(x) ifelse(x %in% tab_FFT1_FFT2$mags,"*","ns"))


#tab_CON1_CON2
index <- match(rownames(tax_heatmap), tab_CON1_CON2_all$mags)
index
tax_heatmap$CON1_CON2_p <- tab_CON1_CON2_all$p[index]
tax_heatmap$CON1_CON2_p[tax_heatmap$CON1_CON2_p=="NaN"] <- 1

#tab_CON1_FFT1
index <- match(rownames(tax_heatmap), tab_CON1_FFT1_all$mags)
index
tax_heatmap$CON1_FFT1_p <- tab_CON1_FFT1_all$p[index]
tax_heatmap$CON1_FFT1_p[tax_heatmap$CON1_FFT1_p=="NaN"] <- 1


#tab_CON1_FFT2
index <- match(rownames(tax_heatmap), tab_CON1_FFT2_all$mags)
index
tax_heatmap$CON1_FFT2_p <- tab_CON1_FFT2_all$p[index]
tax_heatmap$CON1_FFT2_p[tax_heatmap$CON1_FFT2_p=="NaN"] <- 1

#tab_CON2_FFT1
index <- match(rownames(tax_heatmap), tab_CON2_FFT1_all$mags)
index
tax_heatmap$CON2_FFT1_p <- tab_CON2_FFT1_all$p[index]
tax_heatmap$CON2_FFT1_p[tax_heatmap$CON2_FFT1_p=="NaN"] <- 1

#tab_CON2_FFT2
index <- match(rownames(tax_heatmap), tab_CON2_FFT2_all$mags)
index
tax_heatmap$CON2_FFT2_p <- tab_CON2_FFT2_all$p[index]
tax_heatmap$CON2_FFT2_p[tax_heatmap$CON2_FFT2_p=="NaN"] <- 1

#tab_FFT1_FFT2
index <- match(rownames(tax_heatmap), tab_FFT1_FFT2_all$mags)
index
tax_heatmap$FFT1_FFT2_p <- tab_FFT1_FFT2_all$p[index]
tax_heatmap$FFT1_FFT2_p[tax_heatmap$FFT1_FFT2_p=="NaN"] <- 1

tax_heatmap <- tax_heatmap[order(tax_heatmap$CON1_CON2_p,
                                 tax_heatmap$CON1_FFT1_p,
                                 tax_heatmap$CON1_FFT2_p,
                                 tax_heatmap$CON2_FFT1_p,
                                 tax_heatmap$CON2_FFT2_p,
                                 tax_heatmap$FFT1_FFT2_p),]


#note: PyT_UnT_p replaced FMT2vsCON_p

# sorted_indice <- order(tax_heatmap$Species)
# sorted_indice
# tax_heatmap <-tax_heatmap[sorted_indice,]

# my_palette <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","darkblue")
# 
# my_palette <- c("darkblue", "darkgoldenrod1", "darkseagreen", "darkorchid", "darkolivegreen1", "lightskyblue", "darkgreen", "deeppink", "khaki2", "firebrick", "brown1", "darkorange1", "cyan1", "royalblue4", "darksalmon", "darkblue", "royalblue4", "dodgerblue3", "steelblue1", "lightskyblue", "darkseagreen", "darkgoldenrod1", "darkseagreen", "darkorchid", "darkolivegreen1", "brown1", "darkorange1", "cyan1", "darkgrey", "darkblue", "darkgoldenrod1", "darkseagreen", "darkorchid", "darkolivegreen1", "lightskyblue", "darkgreen", "deeppink", "khaki2", "firebrick", "brown1", "darkorange1", "cyan1", "royalblue4", "darksalmon", "darkblue", "royalblue4", "dodgerblue3", "steelblue1", "lightskyblue", "darkseagreen", "darkgoldenrod1", "darkseagreen", "darkorchid", "darkolivegreen1", "brown1", "darkorange1", "cyan1", "darkgrey")
# 
my_palette <- c("orangered4","red","purple","maroon1","lawngreen","blue","orange1","wheat2","violetred3","turquoise3","tomato2","thistle2","tan2","steelblue4","springgreen4","snow4","yellow2","slategray2","slateblue4","sienna4","orchid4","royalblue3","cyan1","darkmagenta","burlywood4","black")

library(RColorBrewer)
# colors <- brewer.pal(12, "Paired")
# more_colors <- brewer.pal(10, "Set3")
# all_colors <- c(colors, more_colors)
# my_palette <- rep(all_colors, length.out = 30)

tax_heatmap$species_p <- stringr::str_replace(as.character(tax_heatmap$Species), " ","_")
tax_heatmap$species_p <- stringr::str_replace(as.character(tax_heatmap$Species), "_","")

species <- unique(as.character(tax_heatmap$species_p))
species_col <- colorRampPalette(my_palette[1:27])(length(species))
names(species_col) <- species

# tax_heatmap$family_p <- stringr::str_replace(as.character(tax_heatmap$Family), " ","_")
# tax_heatmap$family_p <- stringr::str_replace(as.character(tax_heatmap$Family), "_","")
# 
# family <- unique(as.character(tax_heatmap$family_p))
# family_col <- colorRampPalette(my_palette[1:27])(length(family))
# names(family_col) <- family





# magSource <- unique(as.character(tax_heatmap$source))
# magSource_col <- colorRampPalette(my_palette[1:12])(length(magSource))
# names(magSource_col) <- magSource
pvalue_col_fun = colorRamp2(c(0, 1, 2), c("lightseagreen", "white", "red"))
# ha_row <- HeatmapAnnotation(CHPvsLFD=anno_simple(-log10(tax_heatmap$CON2_FFT2_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_CON2_FFT2,"ns")),
#                             SDTvsLFD=anno_simple(-log10(tax_heatmap$CON2_FFT1_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_CON2_FFT1,"ns")),
#                             PYTvsLFD=anno_simple(-log10(tax_heatmap$PyT_LFD_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_PyT_LFD,"ns")),
#                             UNTvsLFD=anno_simple(-log10(tax_heatmap$UnT_LFD_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_UnT_LFD,"ns")),
#                             HFDvsLFD=anno_simple(-log10(tax_heatmap$HFD_LFD_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_HFD_LFD,"ns")),
#                             CHPvsHFD=anno_simple(-log10(tax_heatmap$ChP_HFD_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_ChP_HFD,"ns")),
#                             SDTvsHFD=anno_simple(-log10(tax_heatmap$SDT_HFD_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_SDT_HFD,"ns")),
#                             PYTvsHFD=anno_simple(-log10(tax_heatmap$PyT_HFD_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_PyT_HFD,"ns")),
#                             UNTvsHFD=anno_simple(-log10(tax_heatmap$UnT_HFD_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_UnT_HFD,"ns")),
#                             CHPvsUNT=anno_simple(-log10(tax_heatmap$ChP_UnT_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_ChP_UnT,"ns")),
#                             SDTvsUNT=anno_simple(-log10(tax_heatmap$SDT_UnT_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_SDT_UnT,"ns")),
#                             PYTvsUNT=anno_simple(-log10(tax_heatmap$PyT_UnT_p),col = pvalue_col_fun,pch = na_if(tax_heatmap$tab_PyT_UnT,"ns")),
#                             Class=anno_simple(tax_heatmap$class_p, col = class_col),
#                             which = "row")

ha_row <- HeatmapAnnotation(CON1vsCON2=anno_simple(-log10(tax_heatmap$CON1_CON2_p),col = pvalue_col_fun),
CON1vsFFT1=anno_simple(-log10(tax_heatmap$CON1_FFT1_p),col = pvalue_col_fun),
CON1vsFFT2=anno_simple(-log10(tax_heatmap$CON1_FFT2_p),col = pvalue_col_fun),
CON2vsFFT1=anno_simple(-log10(tax_heatmap$CON2_FFT1_p),col = pvalue_col_fun),
CON2vsFFT2=anno_simple(-log10(tax_heatmap$CON2_FFT2_p),col = pvalue_col_fun),
FFT1vsFFT2=anno_simple(-log10(tax_heatmap$FFT1_FFT2_p),col = pvalue_col_fun),
Species=anno_simple(tax_heatmap$species_p, col = species_col),
which = "row")
meta_order$Group <- factor(meta_order$Group, 
                               levels = c("Control1","Control2","FFT1","FFT2"), 
                               labels = c("Control1","Control2","FFT1","FFT2"))


ha_col = HeatmapAnnotation(Group=meta_order$Group,col = list(Group=c("Control1"="#F27970", "Control2"="#BB9727", "FFT1"="#54B345", "FFT2"="#32B897")))

# right_row <- rowAnnotation(foo = anno_text(tax_heatmap$Species))


# mat_scaled<-mat_scaled[rownames(tax_heatmap), ]


# sorted_indice <- order(tax_heatmap$Species)
# sorted_indice
# tax_heatmap <-tax_heatmap[sorted_indice,]

Hist <- Heatmap(mat_scaled[rownames(tax_heatmap),] , cluster_columns = FALSE, cluster_rows = TRUE,
                name="Z-score", col=colorRamp2(c(-2, 0, 2), c("dodgerblue4", "white","deeppink3")),
                top_annotation = ha_col, 
                left_annotation = ha_row,
                show_row_names = FALSE, show_column_names = FALSE,
                heatmap_legend_param = list(legend_direction = "horizontal"))
# +
                # rowAnnotation(species = anno_text(tax_heatmap$Species, just = "left", location = unit(0.5, "npc"), show_name = TRUE), annotation_name_rot = 0)

Hist

# define the two legend
lgd_group = Legend(title = "Group", legend_gp = gpar(fill = c("#F27970", "#BB9727", "#54B345", "#32B897")),
                   labels = c("Control1","Control2","FFT1","FFT2"))

lgd_species = Legend(title = "Species", legend_gp = gpar(fill = species_col),labels = species, ncol = 2)

lgd_sig = Legend(title= " ", pch = "*", type = "points", labels = "p < 0.05")
lgd_pvalue = Legend(title = "p value",
                    col_fun  = pvalue_col_fun,
                    at = c(0, 1, 2, 3, 4),
                    labels = c("1", "0.1", "0.05", "0.01", "0.001"),
                    direction = "horizontal")

draw(Hist, heatmap_legend_list=list(lgd_group, lgd_species,
                                    lgd_pvalue,lgd_sig),
     heatmap_legend_side = "bottom", annotation_legend_side = "bottom")

# write.csv(matscaled,"virome deseq heatmaptesting/star annotation.csv")
# tax_heatmap<-tax_heatmap[rownames(mat_scaled_res), ]


```
